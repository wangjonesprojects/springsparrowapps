<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Sparrow Inventory System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .admin-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: white;
            color: #667eea;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            padding: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .auto-info {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
            color: #0c5460;
        }

        .room-section {
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
        }

        .room-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: 700;
        }

        .room-subheader {
            background: #f093fb;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
        }

        .item-row {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .item-row:nth-child(even) {
            background: #f8f9fa;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        .item-content {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .item-location {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-bottom: 8px;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .radio-label input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
            color: #d9534f;
            font-weight: 600;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .notes-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            border-left: 4px solid #721c24;
            padding: 15px;
            margin: 20px;
            border-radius: 4px;
            color: #721c24;
        }

        .admin-panel {
            padding: 20px;
        }

        .admin-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .admin-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .admin-list {
            list-style: none;
        }

        .admin-list-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-btn-group {
            display: flex;
            gap: 10px;
        }

        .btn-edit {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-delete {
            padding: 6px 12px;
            background: #f45c43;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-add {
            padding: 10px 20px;
            background: #5cb85c;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
        }

        .reports-container {
            padding: 20px;
        }

        .report-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .report-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .report-card.has-issues {
            border-left: 5px solid #f45c43;
        }

        @media (max-width: 768px) {
            .item-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Spring Sparrow Inventory System</h1>
            <button class="admin-btn" onclick="promptAdminAccess()">‚öôÔ∏è Admin</button>
        </div>

        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" onclick="switchTab('checklist')">üìã New Inspection</button>
            <button class="nav-tab" onclick="switchTab('reports')">üìä Reports</button>
        </div>

        <!-- Checklist Tab -->
        <div id="checklist-tab" class="tab-content active">
            <div class="form-section">
                <div class="auto-info">
                    üìÖ <strong>Today's Date:</strong> <span id="currentDate"></span><br>
                    üë• <strong>Inspector:</strong> Vita Professional Cleaning Crew
                </div>

                <form id="inventoryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unitLocation">Unit Location:</label>
                            <select id="unitLocation" required>
                                <option value="">Select Unit...</option>
                            </select>
                        </div>
                    </div>

                    <div id="inventoryItems" class="loading">
                        Loading inventory...
                    </div>

                    <button type="submit" class="submit-btn">üìß Submit Report</button>
                </form>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="reports-container">
                <h2>Inspection Reports</h2>
                <div id="reportsList" class="loading">Loading reports...</div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="admin-tab" class="tab-content">
            <div class="admin-panel">
                <h2>Admin Panel</h2>
                
                <div class="admin-section">
                    <h3>üìç Unit Locations</h3>
                    <ul class="admin-list" id="unitsList"></ul>
                    <button class="btn-add" onclick="addUnit()">+ Add Unit</button>
                </div>

                <div class="admin-section">
                    <h3>üì¶ Sections & Items</h3>
                    <ul class="admin-list" id="sectionsList"></ul>
                    <button class="btn-add" onclick="addSection()">+ Add Section</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC6W83NZRYljB8YrLHGRvDtDBoU_vCBao0",
            authDomain: "spring-sparrow-apps.firebaseapp.com",
            projectId: "spring-sparrow-apps",
            storageBucket: "spring-sparrow-apps.firebasestorage.app",
            messagingSenderId: "1053519751459",
            appId: "1:1053519751459:web:6f88326ed5dd73a3280496",
            measurementId: "G-V34EMQEN8H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global state
        window.db = db;
        window.isAdmin = false;
        window.currentUnits = [];
        window.currentSections = [];

        // Display current date
        const today = new Date();
        document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Initialize app
        async function startApp() {
            try {
                await loadUnits();
                await loadSections();
                renderChecklist();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('inventoryItems').innerHTML = `
                    <div class="error">
                        <strong>Error loading inventory:</strong> ${error.message}<br>
                        Please check Firebase setup and try again.
                    </div>
                `;
            }
        }

        // Load units from Firebase
        async function loadUnits() {
            const unitsSnapshot = await getDocs(collection(db, 'units'));
            window.currentUnits = [];
            unitsSnapshot.forEach(doc => {
                window.currentUnits.push({ id: doc.id, ...doc.data() });
            });

            // Initialize default units if none exist
            if (window.currentUnits.length === 0) {
                const defaultUnits = [
                    { name: "Robin's Roost - 1617 Sheridan - Unit A" },
                    { name: "Dove's Den - 1617 Sheridan - Unit B" },
                    { name: "Orion Apartments - 29 St. Helens, Unit #305" }
                ];
                
                for (const unit of defaultUnits) {
                    const docRef = await addDoc(collection(db, 'units'), unit);
                    window.currentUnits.push({ id: docRef.id, ...unit });
                }
            }

            renderUnitDropdown();
        }

        // Load sections from Firebase
        async function loadSections() {
            const sectionsSnapshot = await getDocs(collection(db, 'sections'));
            window.currentSections = [];
            sectionsSnapshot.forEach(doc => {
                window.currentSections.push({ id: doc.id, ...doc.data() });
            });

            // Initialize default data if none exists
            if (window.currentSections.length === 0) {
                await initializeDefaultData();
            }
        }

        // Initialize default inventory data
        async function initializeDefaultData() {
            const defaultData = {
                name: "Electronics and Appliances",
                rooms: [
                    {
                        name: "Kitchen",
                        items: [
                            { name: "Alexa Speaker", imageUrl: "", location: "Kitchen Counter" },
                            { name: "Noise Monitor", imageUrl: "", location: "Kitchen Wall" },
                            { name: "Nespresso/Keurig Coffee Maker", imageUrl: "", location: "Kitchen Counter" }
                        ]
                    },
                    {
                        name: "Bedroom",
                        items: [
                            { name: "Rectangle Sound Noise Wood Machine", imageUrl: "", location: "Nightstand" }
                        ]
                    },
                    {
                        name: "Bathroom",
                        items: [
                            { name: "Towel Warmer", imageUrl: "", location: "Bathroom Wall" },
                            { name: "Hair Dryer", imageUrl: "", location: "Under Sink" }
                        ]
                    },
                    {
                        name: "Living Room",
                        items: [
                            { name: "Samsung TV Roku Device", imageUrl: "", location: "TV Stand" },
                            { name: "DREO Radiator Heater", imageUrl: "", location: "Corner" }
                        ]
                    }
                ]
            };

            const docRef = await addDoc(collection(db, 'sections'), defaultData);
            window.currentSections.push({ id: docRef.id, ...defaultData });
        }

        // Render unit dropdown
        function renderUnitDropdown() {
            const select = document.getElementById('unitLocation');
            select.innerHTML = '<option value="">Select Unit...</option>';
            window.currentUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.name;
                select.appendChild(option);
            });
        }

        // Render checklist
        function renderChecklist() {
            const container = document.getElementById('inventoryItems');
            container.innerHTML = '';

            window.currentSections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'room-section';

                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'room-header';
                sectionHeader.textContent = section.name;
                sectionDiv.appendChild(sectionHeader);

                section.rooms?.forEach(room => {
                    const roomHeader = document.createElement('div');
                    roomHeader.className = 'room-subheader';
                    roomHeader.textContent = room.name;
                    sectionDiv.appendChild(roomHeader);

                    room.items?.forEach((item, idx) => {
                        const itemRow = document.createElement('div');
                        itemRow.className = 'item-row';

                        if (item.imageUrl) {
                            const img = document.createElement('img');
                            img.className = 'item-image';
                            img.src = item.imageUrl;
                            img.alt = item.name;
                            itemRow.appendChild(img);
                        }

                        const itemContent = document.createElement('div');
                        itemContent.className = 'item-content';

                        itemContent.innerHTML = `
                            <div class="item-name">${item.name}</div>
                            ${item.location ? `<div class="item-location">üìç ${item.location}</div>` : ''}
                            <div class="controls">
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="item_${section.id}_${room.name}_${idx}" value="yes" required> Yes
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="item_${section.id}_${room.name}_${idx}" value="no"> No
                                    </label>
                                </div>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="item_${section.id}_${room.name}_${idx}_damage"> Damaged
                                </label>
                            </div>
                            <input type="text" class="notes-input" name="item_${section.id}_${room.name}_${idx}_notes" placeholder="Notes (optional)">
                        `;

                        itemRow.appendChild(itemContent);
                        sectionDiv.appendChild(itemRow);
                    });
                });

                container.appendChild(sectionDiv);
            });
        }

        // Form submission
        document.getElementById('inventoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const unitSelect = document.getElementById('unitLocation');
            
            const report = {
                date: new Date().toISOString().split('T')[0],
                unit: unitSelect.value,
                unitName: unitSelect.selectedOptions[0].text,
                inspector: "Vita Professional Cleaning Crew",
                timestamp: new Date().toISOString(),
                items: []
            };

            // Collect all item data
            window.currentSections.forEach(section => {
                section.rooms?.forEach(room => {
                    room.items?.forEach((item, idx) => {
                        const status = formData.get(`item_${section.id}_${room.name}_${idx}`);
                        const damaged = formData.get(`item_${section.id}_${room.name}_${idx}_damage`);
                        const notes = formData.get(`item_${section.id}_${room.name}_${idx}_notes`);

                        report.items.push({
                            section: section.name,
                            room: room.name,
                            name: item.name,
                            status: status,
                            damaged: !!damaged,
                            notes: notes || ''
                        });
                    });
                });
            });

            try {
                await addDoc(collection(db, 'reports'), report);
                alert('‚úÖ Report submitted successfully!');
                e.target.reset();
            } catch (error) {
                alert('‚ùå Error submitting report: ' + error.message);
            }
        });

        // Admin access
        window.promptAdminAccess = function() {
            const passcode = prompt('Enter admin passcode:');
            if (passcode === '2008') {
                window.isAdmin = true;
                showAdminPanel();
            } else if (passcode) {
                alert('Incorrect passcode');
            }
        };

        function showAdminPanel() {
            const adminTab = document.createElement('button');
            adminTab.className = 'nav-tab';
            adminTab.textContent = '‚öôÔ∏è Admin';
            adminTab.onclick = () => switchTab('admin');
            document.getElementById('navTabs').appendChild(adminTab);
            
            switchTab('admin');
            renderAdminPanel();
        }

        function renderAdminPanel() {
            const unitsList = document.getElementById('unitsList');
            unitsList.innerHTML = '';
            window.currentUnits.forEach(unit => {
                const li = document.createElement('li');
                li.className = 'admin-list-item';
                li.innerHTML = `
                    <span>${unit.name}</span>
                    <div class="admin-btn-group">
                        <button class="btn-delete" onclick="deleteUnit('${unit.id}')">Delete</button>
                    </div>
                `;
                unitsList.appendChild(li);
            });

            const sectionsList = document.getElementById('sectionsList');
            sectionsList.innerHTML = '';
            window.currentSections.forEach(section => {
                const li = document.createElement('li');
                li.className = 'admin-list-item';
                li.innerHTML = `
                    <span>${section.name} (${section.rooms?.length || 0} rooms)</span>
                `;
                sectionsList.appendChild(li);
            });
        }

        // Tab switching
        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'reports') {
                loadReports();
            }
        };

        // Load reports
        async function loadReports() {
            const reportsList = document.getElementById('reportsList');
            reportsList.innerHTML = '<div class="loading">Loading reports...</div>';

            try {
                const reportsSnapshot = await getDocs(collection(db, 'reports'));
                const reports = [];
                reportsSnapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });

                reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                if (reports.length === 0) {
                    reportsList.innerHTML = '<p>No reports yet.</p>';
                    return;
                }

                reportsList.innerHTML = '';
                reports.forEach(report => {
                    const missingCount = report.items.filter(i => i.status === 'no').length;
                    const damagedCount = report.items.filter(i => i.damaged).length;
                    const hasIssues = missingCount > 0 || damagedCount > 0;

                    const card = document.createElement('div');
                    card.className = `report-card ${hasIssues ? 'has-issues' : ''}`;
                    card.innerHTML = `
                        <h3>${report.unitName}</h3>
                        <p><strong>Date:</strong> ${report.date}</p>
                        <p><strong>Inspector:</strong> ${report.inspector}</p>
                        <p><strong>Status:</strong> ${hasIssues ? `‚ö†Ô∏è ${missingCount} missing, ${damagedCount} damaged` : '‚úÖ All Clear'}</p>
                    `;
                    reportsList.appendChild(card);
                });
            } catch (error) {
                reportsList.innerHTML = `<div class="error">Error loading reports: ${error.message}</div>`;
            }
        }

        // Admin functions
        window.addUnit = function() {
            const name = prompt('Enter unit name:');
            if (name) {
                addDoc(collection(db, 'units'), { name }).then(() => {
                    loadUnits().then(renderAdminPanel);
                });
            }
        };

        window.deleteUnit = function(id) {
            if (confirm('Delete this unit?')) {
                deleteDoc(doc(db, 'units', id)).then(() => {
                    loadUnits().then(renderAdminPanel);
                });
            }
        };

        window.addSection = function() {
            alert('Section management coming soon!');
        };

        // Start the app
        startApp();
    </script>
</body>
</html>
